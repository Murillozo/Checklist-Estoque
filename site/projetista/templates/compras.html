{% extends 'base.html' %}
{% block body %}
  <h1 class="mb-4">Solicitações em Compras</h1>
  <table id="compras-table" class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Obra</th>
        <th>Itens</th>
        <th>Pendências</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody>
    {% for sol in solicitacoes %}
      <tr>
        <td>{{ sol.id }}</td>
        <td>{{ sol.obra }}</td>
        <td>
          <ul class="mb-0">
          {% for it in sol.itens %}
            <li>
              {{ it.referencia }} <span class="badge bg-secondary">{{ it.quantidade }}</span>
            </li>
          {% endfor %}
          </ul>
        </td>
        <td>
          {% if sol.pendencias_list %}
              <ul class="mb-0">
              {% for p in sol.pendencias_list %}
                <li>
                  {{ p.referencia }}
                  <div class="small text-muted">Falta:</div>
                  <span class="badge bg-warning text-dark">{{ p.quantidade }}</span>
                  {% set item_id = None %}
                  {% for it in sol.itens %}
                    {% if it.referencia == p.referencia %}
                      {% set item_id = it.id %}
                    {% endif %}
                  {% endfor %}
                  <select class="form-select form-select-sm d-inline-block w-auto ms-2 item-status" data-item-id="{{ item_id }}">
                    {% for s in status_options %}
                      <option value="{{ s }}" {% if p.status == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                  </select>
                  <button type="button" class="btn btn-sm btn-info ms-1 btn-history" data-item-id="{{ item_id }}">Histórico</button>
                </li>
              {% endfor %}
              </ul>
          {% else %}
            <span class="text-success">Nenhuma</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('compras.concluir', id=sol.id) }}">
            <button type="submit" class="btn btn-sm btn-success btn-concluir" style="display:none;">Solicitação Concluida</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="text-muted">Nenhuma solicitação em compras.</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">Histórico de Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="historyList" class="list-group mb-0"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.querySelector('#compras-table tbody');
    const statusOptions = {{ status_options|tojson|safe }};

    function renderPendencias(list, itens) {
      if (!list || !list.length) {
        return '<span class="text-success">Nenhuma</span>';
      }
      return '<ul class="mb-0">' +
        list.map(p => {
          const it = itens.find(i => i.referencia === p.referencia) || {};
          const opts = statusOptions
            .map(s => `<option value="${s}" ${it.status === s ? 'selected' : ''}>${s}</option>`)
            .join('');
          return `<li>${p.referencia}<div class="small text-muted">Falta:</div>` +
                 `<span class="badge bg-warning text-dark">${p.quantidade}</span>` +
                 `<select class="form-select form-select-sm d-inline-block w-auto ms-2 item-status" data-item-id="${it.id || ''}">${opts}</select>` +
                 `<button type="button" class="btn btn-sm btn-info ms-1 btn-history" data-item-id="${it.id || ''}">Histórico</button>` +
                 `</li>`;
        }).join('') +
        '</ul>';
    }

  function renderItens(itens) {
      return '<ul class="mb-0">' +
        itens.map(it => {
          return `<li>${it.referencia} <span class="badge bg-secondary">${it.quantidade}</span></li>`;
        }).join('') +
        '</ul>';
    }

    function updateButtonState(row) {
      const selects = row.querySelectorAll('.item-status');
      const btn = row.querySelector('.btn-concluir');
      if (!btn) return;
      if (selects.length === 0) {
        btn.style.display = 'inline-block';
        return;
      }
      const allDelivered = Array.from(selects).every(s => s.value === 'Entregue');
      btn.style.display = allDelivered ? 'inline-block' : 'none';
    }

    function attachListeners() {
      document.querySelectorAll('.item-status').forEach(sel => {
        sel.addEventListener('change', async () => {
          const id = sel.dataset.itemId;
          const status = sel.value;
          await fetch(`/compras/item/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
          });
          updateButtonState(sel.closest('tr'));
        });
      });

      document.querySelectorAll('.btn-history').forEach(btn => {
        btn.addEventListener('click', () => showHistory(btn.dataset.itemId));
      });
    }

    async function showHistory(itemId) {
      const resp = await fetch(`/compras/item/${itemId}/history`);
      if (!resp.ok) return;
      const data = await resp.json();
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      data.forEach(h => {
        const li = document.createElement('li');
        const dt = new Date(h.changed_at);
        li.className = 'list-group-item';
        li.textContent = `${dt.toLocaleString()} : ${h.old_status} → ${h.new_status}`;
        list.appendChild(li);
      });
      const modal = new bootstrap.Modal(document.getElementById('historyModal'));
      modal.show();
    }

    async function fetchData() {
      const resp = await fetch('/projetista/api/solicitacoes');
      if (!resp.ok) return;
      const data = await resp.json();
      tbody.innerHTML = '';
      data.filter(sol => sol.status === 'compras').forEach(sol => {
        let row = document.createElement('tr');
        row.innerHTML = `
          <td>${sol.id}</td>
          <td>${sol.obra}</td>
          <td>${renderItens(sol.itens)}</td>
          <td>${renderPendencias(JSON.parse(sol.pendencias || '[]'), sol.itens)}</td>
          <td>
            <form method="post" action="/compras/${sol.id}/concluir">
              <button type="submit" class="btn btn-sm btn-success btn-concluir" style="display:none;">Solicitação Concluida</button>
            </form>
          </td>`;
        tbody.appendChild(row);
        updateButtonState(row);
      });
      attachListeners();
    }

    fetchData();
    setInterval(fetchData, 5000);
  </script>
{% endblock %}
