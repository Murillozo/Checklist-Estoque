{% extends 'base.html' %}
{% block body %}
  <h1 class="mb-4">Solicitações em Compras</h1>
  <table id="compras-table" class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Obra</th>
        <th>Itens</th>
        <th>Pendências</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody>
    {% for sol in solicitacoes %}
      <tr>
        <td>{{ sol.id }}</td>
        <td>{{ sol.obra }}</td>
        <td>
          <ul class="mb-0">
          {% for it in sol.itens %}
            <li>{{ it.referencia }} <span class="badge bg-secondary">{{ it.quantidade }}</span></li>
          {% endfor %}
          </ul>
        </td>
        <td>
          {% if sol.pendencias_list %}
            <ul class="mb-0">
            {% for p in sol.pendencias_list %}
              <li>
                {{ p.referencia }} <span class="badge bg-warning text-dark">{{ p.quantidade }}</span>
                <select class="form-select form-select-sm d-inline-block w-auto ms-2 item-status" data-item-id="{{ p.item_id }}">
                  {% for s in status_options %}
                    <option value="{{ s }}" {% if p.status == s %}selected{% endif %}>{{ s }}</option>
                  {% endfor %}
                </select>
              </li>
            {% endfor %}
            </ul>
          {% else %}
            <span class="text-success">Nenhuma</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('compras.concluir', id=sol.id) }}">
            <button type="submit" class="btn btn-sm btn-success">Concluir</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="text-muted">Nenhuma solicitação em compras.</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <script>
    const tbody = document.querySelector('#compras-table tbody');
    const statusOptions = {{ status_options|tojson }};

    function renderPendencias(list, itens) {
      if (!list || !list.length) {
        return '<span class="text-success">Nenhuma</span>';
      }
      return '<ul class="mb-0">' +
        list.map(p => {
          const it = itens.find(i => i.referencia === p.referencia) || {};
          const opts = statusOptions
            .map(s => `<option value="${s}" ${it.status === s ? 'selected' : ''}>${s}</option>`)
            .join('');
          return `<li>${p.referencia} <span class="badge bg-warning text-dark">${p.quantidade}</span>` +
                 `<select class="form-select form-select-sm d-inline-block w-auto ms-2 item-status" data-item-id="${it.id || ''}">${opts}</select></li>`;
        }).join('') +
        '</ul>';
    }

    function renderItens(itens) {
      return '<ul class="mb-0">' +
        itens.map(it => `<li>${it.referencia} <span class="badge bg-secondary">${it.quantidade}</span></li>`).join('') +
        '</ul>';
    }

    function attachListeners() {
      document.querySelectorAll('.item-status').forEach(sel => {
        sel.addEventListener('change', async () => {
          const id = sel.dataset.itemId;
          const status = sel.value;
          await fetch(`/compras/item/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
          });
        });
      });
    }

    async function fetchData() {
      const resp = await fetch('/projetista/api/solicitacoes');
      if (!resp.ok) return;
      const data = await resp.json();
      tbody.innerHTML = '';
      data.filter(sol => sol.status === 'compras').forEach(sol => {
        let row = document.createElement('tr');
        row.innerHTML = `
          <td>${sol.id}</td>
          <td>${sol.obra}</td>
          <td>${renderItens(sol.itens)}</td>
          <td>${renderPendencias(JSON.parse(sol.pendencias || '[]'), sol.itens)}</td>
          <td>
            <form method="post" action="/compras/${sol.id}/concluir">
              <button type="submit" class="btn btn-sm btn-success">Concluir</button>
            </form>
          </td>`;
        tbody.appendChild(row);
      });
      attachListeners();
    }

    fetchData();
    setInterval(fetchData, 5000);
  </script>
{% endblock %}
