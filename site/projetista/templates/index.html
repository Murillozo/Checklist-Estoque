{% extends 'base.html' %}
{% block body %}
  <h1 class="mb-4">Status das Solicitações</h1>
  <div class="mb-3 col-md-4">
    <label for="status-filter" class="form-label">Filtrar por Status</label>
    <select id="status-filter" class="form-select">
      <option value="">Todos</option>
      <option value="analise">Aguardando Andamento</option>
      <option value="aprovado">Separado</option>
      <option value="compras">Pendente em compras</option>
    </select>
  </div>
  <table id="status-table" class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Obra</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
    {% for sol in solicitacoes %}
      <tr data-status="{{ sol.status }}">
        <td>{{ sol.id }}</td>
        <td>{{ sol.obra }}</td>
        <td>
          {% if sol.status == 'analise' %}
            Em análise
          {% elif sol.status == 'concluido' %}
            Concluído
          {% else %}
            {{ sol.status }}
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('projetista.delete_solicitacao', id=sol.id) }}" onsubmit="return confirm('Confirma apagar?');">
            <button type="submit" class="btn btn-sm btn-danger">Apagar</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="4" class="text-muted">Nenhuma solicitação registrada.</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  <script>
    const select = document.getElementById('status-filter');
    const tbody = document.querySelector('#status-table tbody');

    function applyFilter() {
      const val = select.value;
      document.querySelectorAll('#status-table tbody tr').forEach(row => {
        row.style.display = (!val || row.dataset.status === val) ? '' : 'none';
      });
    }

    select.addEventListener('change', applyFilter);

    function renderStatus(status) {
      const map = {
        analise: 'Aguardando Andamento',
        aprovado: 'Separado',
        compras: 'Pendente em compras',
      };
      return map[status] || status;
    }

    async function fetchData() {
      const resp = await fetch('/projetista/api/solicitacoes');
      if (!resp.ok) return;
      const data = await resp.json();
      tbody.innerHTML = '';
      data.forEach(sol => {
        const tr = document.createElement('tr');
        tr.dataset.status = sol.status;
        tr.innerHTML = `
          <td>${sol.id}</td>
          <td>${sol.obra}</td>
          <td>${renderStatus(sol.status)}</td>
          <td>
            <form method="post" action="/projetista/solicitacao/${sol.id}/delete" onsubmit="return confirm('Confirma apagar?');">
              <button type="submit" class="btn btn-sm btn-danger">Apagar</button>
            </form>
          </td>`;
        tbody.appendChild(tr);
      });
      applyFilter();
    }

    fetchData();
    setInterval(fetchData, 5000);
  </script>
{% endblock %}
